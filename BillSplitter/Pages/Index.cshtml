@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div id="app">

    <div class="row">
        <div class="col">
            <h4>Bills</h4>
            
            <div class="list-group mb-3">
                <a v-on:click="loadBill(b.id)" v-for="b in bills" href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">${{ b.amount }}</h5>
                        <small>{{ b.paidDate }}</small>
                    </div>
                    <p class="mb-1">{{ b.description }}</p>
                    <small>{{ b.paidByRoomMate.firstName }} {{ b.paidByRoomMate.lastName }}</small>
                </a>
            </div>
            
            <button v-show="!ui.showNewBillForm" class="btn btn-primary btn-block" v-on:click="ui.showNewBillForm=true">Add a new Bill</button>
            
            <form v-on:submit.prevent.stop="saveNewBill" v-show="ui.showNewBillForm">
                <h5>New Bill Information</h5>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" v-model="form.newBillForm.description" class="form-control"/>
                </div>

                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" v-model.number="form.newBillForm.amount" step="any" class="form-control"/>
                </div>
                
                <div class="form-group">
                    <label>Paid Date</label>
                    <input type="date" v-model="form.newBillForm.paidDate" class="form-control"/>
                </div>
                
                <div class="form-group">
                    <label>Paid By</label>
                    <select v-model="form.newBillForm.paidByRoomMateId" class="form-control">
                        <option>Select...</option>
                        <option v-for="r in roomMates" :value="r.id">{{ r.firstName }} {{ r.lastName }}</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary btn-block">Save Bill</button>

            </form>
        </div>
        <div class="col">
            <h4>Payment Information</h4>

            <div v-if="selectedBill" class="list-group mb-3">
                <a v-for="p in selectedBill.bill.payments" href="#" class="list-group-item list-group-item-action flex-column align-items-start">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">${{ p.amount }}</h5>
                        <small>{{ p.paidDate }}</small>
                    </div>
                    <p class="mb-1">{{ p.details }}</p>
                    <small>{{ p.roomMate.firstName }} {{ p.roomMate.lastName }}</small>
                </a>
            </div>

            <form v-if="selectedBill" v-on:submit.prevent.stop="saveNewPayment">
                <h5>New Bill Information</h5>

                <div class="form-group">
                    <label>Paid By</label>
                    <select v-model="form.newPaymentForm.roomMateId" class="form-control">
                        <option>Select...</option>
                        <option v-for="r in selectedBill.roomMates" :value="r.id">{{ r.firstName }} {{ r.lastName }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" :placeholder="selectedBill.amountPerPerson" v-model.number="form.newPaymentForm.amount" step="any" class="form-control" />
                    <small>Expected Amount: ${{selectedBill.amountPerPerson}}</small>
                </div>

                <div class="form-group">
                    <label>Details</label>
                    <textarea type="text" v-model="form.newPaymentForm.details" class="form-control"></textarea>
                </div>

                <div class="form-group">
                    <label>Paid Date</label>
                    <input type="date" v-model="form.newPaymentForm.paidDate" class="form-control" />
                </div>



                <button type="submit" class="btn btn-primary btn-block">Save Bill</button>

            </form>
        </div>
    </div>

</div>

@section Scripts
{
    <script>

        var app = new Vue({
            el: "#app",
            data: {
                // PLACE DATA PROPERTIES HERE - THIS IS THE "MODEL" FOR OUR PROGRAM
                roomMates: [],
                bills: [],
                selectedBill: null,
                ui: {
                    showNewBillForm: false
                },
                form: {
                    newBillForm: {
                        description: "",
                        amount: null,
                        paidDate: null,
                        paidByRoomMateId: null
                    },
                    newPaymentForm: {
                        details: "",
                        amount: null,
                        paidDate: null,
                        roomMateId: null,
                        billId: null
                    }
                }
            },
            mounted: function() {
                // PERFORM ANY ACTIONS WHEN THE PAGE LOADS HERE - SIMILAR TO JQUERY DOCUMENT.READY
                var self = this;
                $.ajax({
                    method: "GET",
                    url: "/api/roommates",
                    dataType: "JSON",
                    contentType: "application/json"
                }).done(function(data) {
                    self.roomMates = data;
                }).fail(function() {
                    console.log("Something went wrong");
                });

                self.getAllBills();

                setInterval(function() {
                        self.getAllBills();
                    }, 5000);

            },
            methods: {
                // ADD ANY METHODS (CLICK, SUBMIT EVENTS, ETC.)
                saveNewBill: function() {
                    var self = this;
                    var json = JSON.stringify(self.form.newBillForm);
                    $.ajax({
                        method: "POST",
                        url: "/api/bills",
                        dataType: "JSON",
                        contentType: "application/json",
                        data: json
                    }).done(function(data) {
                        console.log("data submitted successfully");
                        self.getAllBills();
                        self.form.newBillForm.description = "";
                        self.form.newBillForm.amount = null;
                        self.form.newBillForm.paidDate = null;
                        self.form.newBillForm.paidByRoomMateId = null;
                        self.ui.showNewBillForm = false;
                    }).fail(function() {
                        alert("Something went wrong");
                    });
                },
                saveNewPayment: function() {
                    var self = this;
                    self.form.newPaymentForm.billId = self.selectedBill.bill.id;
                    var json = JSON.stringify(self.form.newPaymentForm);
                    
                    $.ajax({
                        method: "POST",
                        url: "/api/payments",
                        dataType: "JSON",
                        contentType: "application/json",
                        data: json
                    }).done(function(data) {
                        console.log("data submitted successfully");
                        self.getAllBills();
                    }).fail(function() {
                        alert("Something went wrong");
                    });
                },
                getAllBills: function() {
                    var self = this;
                    $.ajax({
                        method: "GET",
                        url: "/api/bills",
                        dataType: "JSON",
                        contentType: "application/json"
                    }).done(function(data) {
                        self.bills = data;
                    }).fail(function() {
                        console.log("Something went wrong");
                    });
                },
                loadBill: function(billId) {
                    var self = this;

                    $.ajax({
                        method: "GET",
                        url: "/api/bills/" + billId,
                        dataType: "JSON",
                        contentType: "application/json"
                    }).done(function(data) {
                        self.selectedBill = data;
                    }).fail(function() {
                        console.log("Something went wrong");
                    });
                }
            },
            computed: {
                // CREATE ANY CALCULATED PROPERTIES HERE. THEY BEHAVE LIKE READ-ONLY DATA
            
            }
        });

    </script>
}